package com.uwb.bt2j.util;

import java.io.File;

public class BitpairOutFileBuf {
	public BitpairOutFileBuf(String in) {
		bpPtr_ = 0;
		cur_ = 0;
		out_ = new File(in);
		if(out_ == null) {
			System.err.println("Error: Could not open bitpair-output file " + in);
		}
	}
	
	public void write(int bp) {
		buf_[cur_] |= (bp << bpPtr_);
		if(bpPtr_ == 6) {
			bpPtr_ = 0;
			cur_++;
			if(cur_ == BUF_SZ) {
				// Flush the buffer
				if(!fwrite(buf_, BUF_SZ, 1, out_)) {
					System.err.println("Error writing to the reference index file (.4.ebwt)");
				}
				// Reset to beginning of the buffer
				cur_ = 0;
			}
			// Initialize next octet to 0
			buf_[cur_] = 0;
		} else {
			bpPtr_ += 2;
		}
	}
	
	public void close() {
		if(cur_ > 0 || bpPtr_ > 0) {
			if(bpPtr_ == 0) cur_--;
			if(!fwrite(buf_, cur_ + 1, 1, out_)) {
				System.err.println("Error writing to the reference index file (.4.ebwt)");
			}
		}
		fclose(out_);
	}
}
