package com.uwb.bt2j.aligner.sink;

public class ReportingState {
	public ReportingParams p_;  // reporting parameters
	public int state_;          // state we're currently in
	public Boolean paired_;        // true iff read we're currently handling is paired
	public long nconcord_;  // # concordants found so far
	public long ndiscord_;  // # discordants found so far
	public long nunpair1_;  // # unpaired alignments found so far for mate 1
	public long nunpair2_;  // # unpaired alignments found so far for mate 2
	public Boolean doneConcord_;   // true iff we're no longner interested in concordants
	public Boolean doneDiscord_;   // true iff we're no longner interested in discordants
	public Boolean doneUnpair_;    // no longner interested in unpaired alns
	public Boolean doneUnpair1_;   // no longner interested in unpaired alns for mate 1
	public Boolean doneUnpair2_;   // no longner interested in unpaired alns for mate 2
	public int exitConcord_;    // flag indicating how we exited concordant state
	public int exitDiscord_;    // flag indicating how we exited discordant state
	public int exitUnpair1_;    // flag indicating how we exited unpaired 1 state
	public int exitUnpair2_;    // flag indicating how we exited unpaired 2 state
	public Boolean done_;          // done with all alignments
	
	public ReportingState(final ReportingParams p) {
		reset();
	}
	
	public void reset() {
		state_ = 1;
		paired_ = false;
		nconcord_ = 0;
		ndiscord_ = 0;
		nunpair1_ = 0;
		nunpair2_ = 0;
		doneConcord_ = false;
		doneDiscord_ = false;
		doneUnpair_  = false;
		doneUnpair1_ = false;
		doneUnpair2_ = false;
		exitConcord_ = 1;
		exitDiscord_ = 1;
		exitUnpair1_ = 1;
		exitUnpair2_ = 1;
		done_ = false;
	}
	
	public final Boolean inited() {
		return state_ != 1;
	}
	
	public void nextRead(Boolean paired) {
		paired_ = paired;
		if(paired) {
			state_ = 2;
			doneConcord_ = false;
			doneDiscord_ = p_.discord ? false : true;
			doneUnpair1_ = p_.mixed   ? false : true;
			doneUnpair2_ = p_.mixed   ? false : true;
			exitConcord_ = 1;
			exitDiscord_ = p_.discord ? 1:2;
			exitUnpair1_ = p_.mixed   ? 1:2;
			exitUnpair2_ = p_.mixed   ? 1:2;
		} else {
			// Unpaired
			state_ = 4;
			doneConcord_ = true;
			doneDiscord_ = true;
			doneUnpair1_ = false;
			doneUnpair2_ = true;
			exitConcord_ = 2; // not relevant
			exitDiscord_ = 2; // not relevant
			exitUnpair1_ = 1;
			exitUnpair2_ = 2; // not relevant
		}
		doneUnpair_ = doneUnpair1_ && doneUnpair2_;
		done_ = false;
		nconcord_ = ndiscord_ = nunpair1_ = nunpair2_ = 0;
	}
	
	public Boolean foundConcordant() {
		nconcord_++;
		areDone(nconcord_, doneConcord_, exitConcord_);
		// No need to search for discordant alignments if there are one or more
		// concordant alignments.
		doneDiscord_ = true;
		exitDiscord_ = 5;
		if(doneConcord_) {
			// If we're finished looking for concordant alignments, do we have to
			// continue on to search for unpaired alignments?  Only if our exit
			// from the concordant stage is EXIT_SHORT_CIRCUIT_M.  If it's
			// EXIT_SHORT_CIRCUIT_k or EXIT_WITH_ALIGNMENTS, we can skip unpaired.
			if(exitConcord_ != 4) {
				if(!doneUnpair1_) {
					doneUnpair1_ = true;
					exitUnpair1_ = 5;
				}
				if(!doneUnpair2_) {
					doneUnpair2_ = true;
					exitUnpair2_ = 5;
				}
			}
		}
		updateDone();
		return done();
	}
	
	public Boolean foundUnpaired() {
		
	}
	
	public void finish() {
		
	}
	
	public final void getReport(
			long nconcordAln,
			long ndiscordAln, 
			long nunpair1Aln, 
			long nunpair2Aln, 
			Boolean pairMax, 
			Boolean unpair1Max,
			Boolean unpair2Max) {
		
	}
	
	public int state() {
		return state_;
	}
	
	public Boolean doneConcordant() {
		return doneConcord_;
	}
	
	public Boolean doneUnpaired(Boolean mate1) {
		return mate1 ? doneUnpair1_ : doneUnpair2_;
	}
	
	public Boolean doneWithMate(Boolean mate1) {
		Boolean doneUnpair = mate1 ? doneUnpair1_ : doneUnpair2_;
		long nun = mate1 ? nunpair1_ : nunpair2_;
		if(!doneUnpair || !doneConcord_) {
			return false;
		}
		if(!doneDiscord_ && nun == 0) {
			return false;
		}
		return true;
	}
	
	public Boolean doneUnpaired() {
		return doneUnpair_;
	}
	
	public Boolean done() {
		return done_;
	}
	
	public long numConcordant() {
		return nconcord_;
	}
	
	public long numDiscordant() {
		return ndiscord_;
	}

	public long numUnpaired1() {
		return nunpair1_;
	}
	
	public long numUnpaired2() {
		return nunpair2_;
	}
	
	public final ReportingParams params() {
		return p_;
	}
	
	protected void convertUnpairedToDiscordant() {
		exitUnpair1_ = 6;
		exitUnpair2_ = 6;
		nunpair1_ = 0;
		nunpair2_ = 0;
		ndiscord_ = 1;
	}
	
	protected final Boolean areDone(long cnt, Boolean done, int exit) {
		
	}
	
	protected void updateDone() {
		doneUnpair_ = doneUnpair1_ && doneUnpair2_;
		done_ = doneUnpair_ && doneDiscord_ && doneConcord_;
	}
}